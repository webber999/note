# 为什么DNS要使用UDP进行通信，而不是TCP

> 我为什么决心要详细剖析一下这个问题呢？主要有两个方面，一个是在之前的工作中，开发CDN调度模块，在基于DNS的调度中，频繁的涉及到几个概念，但是都没有深入研究；此外，关于DNS的新兴概念，如EDNS，HTTPDNS，DNSSEC，TLS/HTTPS DNS等，也没有从细节原理上掌握，因此，在这里想要彻底撸出一份DNS的思维脑图，记做文档，首先从一个问题引出：“为什么DNS要使用UDP进行通信，而不是TCP？”。另外，发现这里有人总结了同样的问题：[为什么 DNS 使用 UDP 协议](https://draveness.me/whys-the-design-dns-udp-tcp/)，我会作为参考加入自己的知识库。

## DNS概述

DNS是一种用于TCP/IP应用程序的分布式数据库，它提供主机名和IP地址之间的转换。 [RFC 1034](https://tools.ietf.org/html/rfc1034) 详细介绍了DNS的概念和功能， [RFC 1035](https://tools.ietf.org/html/rfc1035) 详细介绍了DNS的规范和实现。

关于DNS命名格式，如果不愿意看冗长的rfc文档，可以参考这里[DNS命名规范](https://docs.aws.amazon.com/zh_cn/Route53/latest/DeveloperGuide/DomainNameFormat.html)，这里详细说明了DNS的命名。

### DNS报文

![image](https://note.youdao.com/yws/api/personal/file/CE18D271527844E8BF218FE5DDA3A224?method=download&shareKey=35a85b22a485032c305d8b2c233a009a)

以上为DNS查询和响应的一般格式，报文由12字节长的首部和4个长度可变的字段组成。在标志中（共16bit），包含QR、opcode、AA、TC、RD、RA、rcode，有几个标志位特殊说明下（为后面做铺垫）：

- TC：1bit，表示“可截断的”，当使用UDP时，当应答报文超过512字节时，会强制截断，只返回前512字节。
- RD：1bit，表示“期望递归”，1表示递归查询，0表示迭代查询
- RA：1bit，表示“可用递归”，即名称服务器是否支持递归查询

### DNS的查询过程

以下为DNS的体系架构，采用分布式集群的方式，DNS服务器一般分三种：根DNS服务器，顶级DNS服务器，权威DNS服务器，这里，我觉得还要加上一个更贴近用户的本地DNS服务器，即Local DNS，一般由用户的终端来自动获取或者用户指定，如114.114.114.114, 8.8.8.8等。

![image](https://pic2.zhimg.com/80/607e9d15fd6d5f9d02f6f4b0adb261b9_720w.jpg?source=1940ef5c)

以下为DNS的查询过程：

![image](https://note.youdao.com/yws/api/personal/file/WEB57f2ca7e6eeaa6e8b00523616f0a1e39?method=download&shareKey=763f1f8e1e33d95cf7ee9358056bd152)

1. 当用户在浏览器中输入URL: `a.163.com/xxx`后 ，为了加快查询速度，浏览器会优先查询自己的DNS缓存列表，这里不同的浏览器的DNS缓存规则可能不太一样，感兴趣的可以深入了解下，如果在浏览器的缓存列表中命中，则直接返回IP，完成域名解析。
2. 如果浏览器缓存未命中，则会把DNS的查询移交给操作系统，操作系统会先检查自己本地的缓存文件是否有这个域名的映射关系，不同的操作系统也会有不同的DNS缓存策略。如果在本地缓存中查询到，就先调用这个IP地址映射，完成域名解析。 
3. 如果操作系统的缓存中也没有找到DNS记录，则会向操作系统自动获取的Local DNS 或者用户手动指定的DNS地址中发起`递归查询`，索要对应的IP记录，完成域名解析。
4. 当LDNS收到DNS查询请求时，会优先去本地配置的Region记录中查找，此解析具有权威性。如果要查询的域名，不在此配置记录中，但后端的缓存服务器集群中存在了此域名的映射关系，且TTL未过期，则返回该记录，完成域名解析，此解析不具有权威性。
5. 如果Local DNS服务器的缓存中没有该域名记录，则LDNS会在缓存中检查是否有该域名对应的权威DNS的地址缓存，如果有的话向权威DNS查询，如果没有的话，则查询是否有com顶级域的缓存，再没有的话，则直接去根DNS服务器发起查询，然后逐步迭代查询到权威服务器，13个根服务器的地址是预置的，一定存在。
6. 如果Local DNS服务器的缓存中有域名记录但是缓存过期，则会回源去权威DNS请求最新的映射记录，并更新缓存；

这里注意：从客户端到本地DNS服务器是属于递归查询，而DNS服务器之间就是的交互查询就是迭代查询。

## 用UDP还是用TCP？

铺垫稍微有点儿多，下面进入正题。

在`TCP/IP详解卷一`中的一个角落，其实是有提到过这个问题的，以下为引用内容：

> 注意到DNS名字服务器使用的熟知端口号无论对UDP还是TCP都是53。这意味着DNS均支持UDP和TCP访问，但我们使用tcpdump观察的所有例子都是采用UDP。那么这两种协议都在什么情况下采用以及采用的理由都是什么呢？
>
> 当名字解析器发出一个查询请求，并且返回响应中的TC（删减标志）比特被设置为1时，它就意味着响应的长度超过了512个字节，而仅返回前512个字节。在遇到这种情况时，名字解析器通常使用TCP重发原来的查询请求，它将允许返回的响应超过512个字节（回想在11.10节讨论的UDP数据报的最大长度）。既然TCP能将用户的数据流分为一些报文段，它就能用多个报文段来传送任意长度的用户数据。
>
> 此外，当一个域的辅助名字服务器在启动时，将从该域的主名字服务器执行区域传送。我们也说过辅助服务器将定时（通常是3小时）向主服务器进行查询以便了解主服务器数据是否发生变动。如果有变动，将执行一次区域传送。区域传送将使用TCP，因为这里传送的数据远比一个查询或响应多得多。
>
> 既然DNS主要使用UDP，无论是名字解析器还是名字服务器都必须自己处理超时和重传。此外，不像其他的使用UDP的Internet应用（TFTP、BOOTP和SNMP），大部分操作集中在局域网上，DNS查询和响应通常经过广域网。分组丢失率和往返时间的不确定性在广域网上比局域网上更大。这样对于DNS客户程序，一个好的重传和超时程序就显得更重要了。

如果你实际的去抓一下DNS的包，会发现DNS的查询和响应包其实大多仅为100字节左右，为了在公网上传输这100字节的内容，如果采用TCP的话，经过三次握手、数据传送、四次挥手（DNS场景可以缩短至三次），这显然会产生更大的数据浪费，以及时延的消耗，然而这所换来的连接的可靠性在这种场景中并没有多大作用。

以下截图分别为使用UDP和TCP去114.114.114.114查询某个域名的抓包内容，可以看到，基于UDP的方式，请求和响应报文分别为90字节和202字节，时延约为28ms，而基于TCP协议的方式，请求和响应报文分别为116字节和228字节，时延约为6ms，算上建连时延和断连时延，约为18ms，时延没有得到明显提升，应该是受单次实验性的影响，不具有代表性，但是如果算上建连断连的所有包，总共有962字节，建连断连的数据占了有用数据的279%！

![image](https://note.youdao.com/yws/api/personal/file/WEB0d0e4991430021d4cff3d307278573b4?method=download&shareKey=bad07bbc36ce20fe5db0c0527ac1dcc3)
基于UDP协议的DNS报文


![image](https://note.youdao.com/yws/api/personal/file/WEB2113282bf5d8e9053e23193d33685211?method=download&shareKey=68b51ced74d8946c1be1fc854d891a6d)
基于TCP协议的DNS报文

从历史发展的角度看，先给出以下结论：

1. 在早先的DNS设计时，互联网的环境也比较简单，使用UDP延时更小，性能更优，而TCP协议只会在区域传输的场景中使用；
2. DNS在互联网的网络链路传输中，主要采用UDP的形式，由于TC字段的设置，UDP携带的消息不应超过512字节，否则会产生截断； 
3. 如果客户端接收到的是一个被截断的DNS报文，则应该通过TC字段判断是否应该使用TCP协议重复发出DNS查询请求；
4. 随着互联网环境变得越来越复杂，DNSSEC（RFC5011）的引入、DNS扩展字段支持IPv6（RFC3596）等使得基于UDP传输的DNS报文被截断的情况变得非常常见；
5. EDNS（RFC6891）的引入，让DNS通过UDP协议可携带最多4096字节的数据，虽然暂时缓解了这种被频繁截断的状况，但是公共DNS对EDNS的支持度还很少，难以大面积普及；此外，当UDP数据包的长度超过MTU时，会导致IP数据包的分片，唯一一个用于增加UDP能够携带数据包大小的EDNS机制被认为不可靠；
6. 最终，`RFC7766 DNS over TCP（Implementation Requirements）` 被推了出来，使用TCP解决UDP无法解决的问题，TCP协议不再是一种重试机制，而是需要跟UDP完全并行支持的协议。

如果随着DNS数据包的逐渐增大，TCP协议额外的开销占比就会降低，因此，在以后的互联网中，基于TCP的DNS的数据包会越来越多。所以，这篇文章的标题的问法，放在现在也许是不合适的了。

## EDNS

## IPSet DNS

## CoreDNS